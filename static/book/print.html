<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">


    <title>Cornucopia</title>
    <meta name="robots" content="noindex" />


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="The Cornucopia book.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
    <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    <link rel="stylesheet" href="././mdbook-admonish.css">
    <link rel="stylesheet" href="./mdbook-admonish.css">

</head>

<style>
    .discord {
        fill: gray;
        vertical-align: middle;
        fill: gray;
        transition: 0.6s;
        vertical-align: middle;
        margin: 6px;
    }

    .discord:hover {
        fill: lightgray
    }
</style>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('ayu')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="introduction/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="introduction/installation.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="introduction/dependencies.html"><strong aria-hidden="true">1.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="introduction/types.html"><strong aria-hidden="true">1.3.</strong> Supported types</a></li></ol></li><li class="chapter-item expanded "><a href="using_cornucopia/using_cornucopia.html"><strong aria-hidden="true">2.</strong> Using Cornucopia</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="using_cornucopia/cli.html"><strong aria-hidden="true">2.1.</strong> CLI</a></li><li class="chapter-item expanded "><a href="using_cornucopia/api.html"><strong aria-hidden="true">2.2.</strong> API</a></li><li class="chapter-item expanded "><a href="using_cornucopia/error_reporting.html"><strong aria-hidden="true">2.3.</strong> Error reporting</a></li></ol></li><li class="chapter-item expanded "><a href="writing_queries/writing_queries.html"><strong aria-hidden="true">3.</strong> Writing queries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="writing_queries/query_annotations.html"><strong aria-hidden="true">3.1.</strong> Query annotations</a></li><li class="chapter-item expanded "><a href="writing_queries/type_annotations.html"><strong aria-hidden="true">3.2.</strong> Type annotations</a></li></ol></li><li class="chapter-item expanded "><a href="using_queries/using_queries.html"><strong aria-hidden="true">4.</strong> Using your generated queries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="using_queries/ergonomic_parameters.html"><strong aria-hidden="true">4.1.</strong> Ergonomic parameters</a></li><li class="chapter-item expanded "><a href="using_queries/db_connections.html"><strong aria-hidden="true">4.2.</strong> Database connections</a></li></ol></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">5.</strong> Examples</a></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">6.</strong> Contributing</a></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
                        <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <a style="color:lightgray;  text-decoration: none;" href="/" class="menu-title">
                    <img style="vertical-align:middle" src="logo.png" height="32" width="32"
                        alt="Website main page link." />
                    Cornucopia
                </a>
                <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/cornucopia-rs/cornucopia" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                    <a class="discord" href="https://discord.gg/nYwUmQDHBZ" title="Discord link"
                        aria-label="Discord link">
                        <svg id="discord-button" width="16" height="16" role="img" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <title>Discord</title>
                            <path
                                d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z" />
                        </svg>
                    </a>


                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Cornucopia is a tool powered by <a href="https://github.com/sfackler/rust-postgres"><code>rust-postgres</code></a> designed to generate type-checked Rust interfaces from your PostgreSQL queries. It works by preparing your queries against an actual database and then running an extensive validation suite on them. Once the queries are prepared and validated, Rust code is generated into a module, which can be imported and used in your project. The basic premise is thus to:</p>
<ol>
<li>Write your PostgreSQL queries.</li>
<li>Use Cornucopia to generate Rust code.</li>
<li>Use the generated code in your project.</li>
</ol>
<p>Compared to other Rust database interfaces, Cornucopia's approach has the benefits of being simple to understand while also generating code that is both ergonomic and free of heavy macros or complex generics. Since Cornucopia generates plain Rust structs, you can also easily build upon the generated items.</p>
<p>Here are some defining features:</p>
<ul>
<li>SQL-first. Your SQL is the only source of truth. No intricate ORM.</li>
<li>Powerful query validation. Catch errors before runtime, with powerful (and pretty) diagnostics.</li>
<li>Supports custom user types (composites, domains, and enums) and one-dimensional arrays.</li>
<li>Sync and async driver support, with optional pooling.</li>
<li>Ergonomic non-allocating row mapping.</li>
<li>Granular type nullity control.</li>
<li>Available as a library and a CLI.</li>
<li>As close to native <code>rust-postgres</code> performance as we can make it.</li>
</ul>
<div id="admonition-info" class="admonition admonish-info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="introduction/introduction.html#admonition-info"></a></p>
</div>
<div>
<p>If you just want to get started without having to read all of this, you can take a look at our <a href="introduction//book/examples.html">examples</a>. </p>
<p><em>This book is pretty short and to the point though, so you should probably at least take a glance.</em></p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="cornucopia"><a class="header" href="#cornucopia">Cornucopia</a></h2>
<p>You can use Cornucopia as a <a href="introduction//usage/cli.html">CLI</a> or a library <a href="introduction//usage/api.html">API</a>, depending on your needs. Make sure to check out these sections later for more info.</p>
<h4 id="cli"><a class="header" href="#cli">CLI</a></h4>
<p>To install the latest released version of the CLI, use <code>cargo install</code>:</p>
<pre><code>cargo install cornucopia
</code></pre>
<h4 id="api"><a class="header" href="#api">API</a></h4>
<p>Import <code>cornucopia</code> in your project's <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">cornucopia = &quot;...&quot; # choose the desired version
</code></pre>
<h2 id="container-manager"><a class="header" href="#container-manager">Container manager</a></h2>
<p>When running in managed mode, Cornucopia spawns a container running a PostgreSQL instance that acts as an ephemeral database. Therefore, you need a working <code>docker</code> or <code>podman</code> command available on your system.</p>
<h4 id="docker"><a class="header" href="#docker">Docker</a></h4>
<p>To use Cornucopia with <code>docker</code> on Linux, non-sudo users need to be in the docker group. For a step-by-step guide, please read the official Docker <a href="https://docs.docker.com/get-docker/">installation</a> and <a href="https://docs.docker.com/engine/install/linux-postinstall/">post-installation</a> docs.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="introduction/installation.html#admonition-note"></a></p>
</div>
<div>
<p>You don't need a container manager if you manage the database yourself.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h1>
<p>The code generated by Cornucopia has a few dependencies that you need to import into your project's <code>Cargo.toml</code>.</p>
<p>This section describes the role of each dependency. Dependencies come in three broad categories:</p>
<ul>
<li>Common required ones.</li>
<li>Choosing between sync and async.</li>
<li>Optional dependencies that extend Cornucopia's capabilities.</li>
</ul>
<h2 id="required"><a class="header" href="#required">Required</a></h2>
<ul>
<li>Postgres type utils: <code>postgres-types</code> <strong>with the <code>derive</code> feature enabled</strong>.</li>
</ul>
<h2 id="choose-one-sync-or-async"><a class="header" href="#choose-one-sync-or-async">Choose one (sync or async)</a></h2>
<h3 id="sync"><a class="header" href="#sync">Sync</a></h3>
<ul>
<li>Client: <code>cornucopia_sync</code>.</li>
<li>Driver: <code>postgres</code>.</li>
</ul>
<div id="admonition-info" class="admonition admonish-info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="introduction/dependencies.html#admonition-info"></a></p>
</div>
<div>
<p>You can achieve synchronous connection pooling with <code>r2d2-postgres</code> without any special integration.</p>
</div>
</div>
<h3 id="async"><a class="header" href="#async">Async</a></h3>
<ul>
<li>Client: <code>cornucopia_async</code>.</li>
<li>Runtime: <code>tokio</code>.</li>
<li>Driver: <code>tokio_postgres</code>.</li>
<li>Async tools: <code>futures</code>.</li>
</ul>
<h4 id="optional-async-connection-pooling"><a class="header" href="#optional-async-connection-pooling">(Optional) Async connection pooling</a></h4>
<p><em>Requires <code>cornucopia_async</code>'s <code>deadpool</code> feature (enabled by default)</em></p>
<ul>
<li>Connection pool <code>deadpool-postgres</code>. </li>
</ul>
<h2 id="optional-extra-types"><a class="header" href="#optional-extra-types">(Optional) Extra types</a></h2>
<p>You can enable additional support for additional PostgreSQL types by adding the corresponding crates and driver features. </p>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th>PostgreSQL</th><th>Rust</th><th>driver feature</th></tr></thead><tbody>
<tr><td><code>serde_json</code></td><td><code>Json</code> <code>JsonB</code></td><td><code>Value</code></td><td><code>with-serde_json-1</code> <em>(*)</em></td></tr>
<tr><td><code>time</code></td><td><code>Time</code> <code>Date</code> <code>Timestamp</code> <code>TimestampTZ</code></td><td><code>Date</code> <code>Time</code> <code>PrimitiveDateTime</code> <code>OffsetDateTime</code></td><td><code>with-time-0_3</code></td></tr>
<tr><td><code>uuid</code></td><td><code>Uuid</code></td><td><code>Uuid</code></td><td><code>with-uuid-1</code></td></tr>
<tr><td><code>eui48</code></td><td><code>MacAddr</code></td><td><code>MacAddress</code></td><td><code>with-eui48-1</code></td></tr>
<tr><td><code>rust_decimal</code></td><td><code>Numeric</code></td><td><code>Decimal</code></td><td><em>(**)</em></td></tr>
</tbody></table>
</div>
<p><em>(*) In addition to the driver feature, the <code>with-serde_json-1</code> feature must also be enabled on the Cornucopia client</em>.</p>
<p><em>(**) Doesn't require any driver feature, but it does require enabling <code>rust_decimal</code>'s <code>db-postgres</code> feature.</em></p>
<h2 id="optional-row-serialization"><a class="header" href="#optional-row-serialization">(Optional) Row serialization</a></h2>
<ul>
<li><code>serde</code> <strong>with the <code>derive</code> feature enabled</strong>.</li>
</ul>
<h2 id="full-dependencies"><a class="header" href="#full-dependencies">Full dependencies</a></h2>
<p>The code block below shows what your dependencies might look like with every feature that async <code>cornucopia</code> supports enabled:</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
# Required
postgres-types = { version = &quot;*&quot;, features = [&quot;derive&quot;] }

# Async
cornucopia_async = { version = &quot;*&quot;, features = [&quot;with-serde_json-1&quot;] }
tokio = { version = &quot;*&quot;, features = [&quot;full&quot;] }
tokio-postgres = { version = &quot;*&quot;, features = [
    &quot;with-serde_json-1&quot;,
    &quot;with-time-0_3&quot;,
    &quot;with-uuid-1&quot;,
    &quot;with-eui48-1&quot;,
] }
futures = &quot;*&quot;
# Async connection pooling
deadpool-postgres = { version = &quot;*&quot; }

# Row serialization
serde = { version = &quot;*&quot;, features = [&quot;derive&quot;] }

# Extra types
serde_json = &quot;*&quot;
time = &quot;*&quot;
uuid = &quot;*&quot;
eui48 = &quot;*&quot;
rust_decimal = { version = &quot;*&quot;, features = [&quot;db-postgres&quot;] }
</code></pre>
<p>If you're generating sync code, your dependencies will look a bit different but this should give you a rough idea.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="introduction/dependencies.html#admonition-note"></a></p>
</div>
<div>
<p>You should use numbered instead of wildcard <code>*</code> dependency versions, this is only for demonstration purposes. You can refer to the crate's <a href="introduction//introduction/examples">examples</a> if you're not sure which versions to use.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supported-types"><a class="header" href="#supported-types">Supported types</a></h1>
<h2 id="base-types"><a class="header" href="#base-types">Base types</a></h2>
<div class="table-wrapper"><table><thead><tr><th>PostgrsQL type</th><th>Rust type</th></tr></thead><tbody>
<tr><td><code>bool</code>, <code>boolean</code></td><td><code>bool</code></td></tr>
<tr><td><code>&quot;char&quot;</code></td><td><code>i8</code></td></tr>
<tr><td><code>smallint</code>, <code>int2</code>, <code>smallserial</code>, <code>serial2</code></td><td><code>i16</code></td></tr>
<tr><td><code>int</code>, <code>int4</code>, <code>serial</code>, <code>serial4</code></td><td><code>i32</code></td></tr>
<tr><td><code>bigint</code>, <code>int8</code>, <code>bigserial</code>, <code>serial8</code></td><td><code>i64</code></td></tr>
<tr><td><code>real</code>, <code>float4</code></td><td><code>f32</code></td></tr>
<tr><td><code>double precision</code>, <code>float8</code></td><td><code>f64</code></td></tr>
<tr><td><code>text</code></td><td><code>String</code></td></tr>
<tr><td><code>varchar</code></td><td><code>String</code></td></tr>
<tr><td><code>bytea</code></td><td><code>Vec&lt;u8&gt;</code></td></tr>
<tr><td><code>timestamp without time zone</code>, <code>timestamp</code> <em>(*)</em></td><td><code>time::PrimitiveDateTime</code></td></tr>
<tr><td><code>timestamp with time zone</code>, <code>timestamptz</code> <em>(*)</em></td><td><code>time::OffsetDateTime</code></td></tr>
<tr><td><code>date</code><em>(*)</em></td><td><code>time::Date</code></td></tr>
<tr><td><code>time</code><em>(*)</em></td><td><code>time::Time</code></td></tr>
<tr><td><code>json</code><em>(*)</em></td><td><code>serde_json::Value</code></td></tr>
<tr><td><code>jsonb</code><em>(*)</em></td><td><code>serde_json::Value</code></td></tr>
<tr><td><code>uuid</code><em>(*)</em></td><td><code>uuid::Uuid</code></td></tr>
<tr><td><code>inet</code><em>(*)</em></td><td><code>std::net::IpAddr</code></td></tr>
<tr><td><code>macaddr</code><em>(*)</em></td><td><code>eui48::MacAddress</code></td></tr>
<tr><td><code>numeric</code> <em>(*)</em></td><td><code>rust_decimal::Decimal</code></td></tr>
</tbody></table>
</div>
<p><em>(*) <a href="introduction/./dependencies#optional-extra-types">Optional extra types</a>.</em></p>
<h2 id="custom-types"><a class="header" href="#custom-types">Custom types</a></h2>
<p>Custom types like <code>enum</code>s, <code>composite</code>s and <code>domain</code>s will be generated automatically by inspecting your database. The only requirement for your custom types is that they should be based on other supported types (base or custom).</p>
<p>Cornucopia is aware of your types' namespaces (what PostgreSQL calls schemas), so it will correctly handle custom types like <code>my_schema.my_custom_type</code>.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="introduction/types.html#admonition-note"></a></p>
</div>
<div>
<p>Domains are unwrapped into their inner types in your Rust queries.</p>
</div>
</div>
<h2 id="array-types"><a class="header" href="#array-types">Array types</a></h2>
<p>Cornucopia supports one-dimensional arrays when the element type is also a type supported. That is, Cornucopia supports <code>example_elem_type[]</code> if <code>example_elem_type</code> is itself a type supported by Cornucopia (base or custom).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-cornucopia"><a class="header" href="#using-cornucopia">Using Cornucopia</a></h1>
<p>You can use Cornucopia as a CLI or a library API depending on your needs. The CLI is simpler and allows you to use the same binary for all your projects, but the library can be used to integrate or automate Cornucopia as part of your own project.</p>
<h2 id="workflows"><a class="header" href="#workflows">Workflows</a></h2>
<p>Cornucopia is flexible with how it can be used. Here are some useful workflows when developing with Cornucopia:</p>
<h3 id="basic"><a class="header" href="#basic">Basic</a></h3>
<p>This is the simplest workflow. Create a <code>queries/</code> directory containing your PostgreSQL queries at the root of your crate. Then, run the CLI to generate a <code>cornucopia.rs</code> file in your <code>src/</code> folder. Note that the CLI will require the path to one or more PostgreSQL schemas to build against. </p>
<p>You're done! Now you can import your generated query items from the <code>cornucopia</code> module. When you modify your queries or schemas, you can re-run the CLI to update the generated code.</p>
<h3 id="automatic-query-rebuild"><a class="header" href="#automatic-query-rebuild">Automatic query rebuild</a></h3>
<p>The setup is the same as the basic workflow, but instead of using the CLI to generate your queries, create a <code>build.rs</code> build script that invokes Cornucopia's API. Build scripts have built-in functionalities that allow them to be re-executed every time your queries or schema(s) change. See this <a href="https://github.com/cornucopia-rs/cornucopia/tree/main/examples/auto_build">example</a> for details.</p>
<h3 id="self-managed-database"><a class="header" href="#self-managed-database">Self-managed database</a></h3>
<p>With this workflow, you don't need a container manager at all. Set up your database in the state you want, then use Cornucopia's <code>live</code> functionality to build directly against this database using a connection URL. Both the CLI and API support this.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-1"><a class="header" href="#cli-1">CLI</a></h1>
<p>The CLI exposes two main commands: <code>schema</code> and <code>live</code>.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="using_cornucopia/cli.html#admonition-note"></a></p>
</div>
<div>
<p>This is only an overview of the CLI. You should read the help message for more complete information (<code>cornucopia --help</code>)</p>
</div>
</div>
<h2 id="generating-code"><a class="header" href="#generating-code">Generating code</a></h2>
<p>The code generation can be made either against a database that you manage or by letting Cornucopia manage an ephemeral database container for you.</p>
<h3 id="schema-automatic-container-management"><a class="header" href="#schema-automatic-container-management"><code>schema</code>: Automatic container management</a></h3>
<p>The <code>cornucopia schema</code> command creates a new container, loads your schema(s), generates your queries and cleanups the container. You will need to provide the path to one or more schema files to build your queries against.</p>
<h3 id="live-manual-database-management"><a class="header" href="#live-manual-database-management"><code>live</code>: Manual database management</a></h3>
<p>If you want to manage the database yourself, use the <code>cornucopia live</code> command to connect to an arbitrary live database. You will need to provide the connection URL.</p>
<h2 id="useful-flags"><a class="header" href="#useful-flags">Useful flags</a></h2>
<h3 id="sync-1"><a class="header" href="#sync-1"><code>sync</code></a></h3>
<p>By default, Cornucopia will generate asynchronous code, but it can also generate synchronous code using the <code>--sync</code> flag.</p>
<h3 id="serialize"><a class="header" href="#serialize"><code>serialize</code></a></h3>
<p>If you need to serialize the rows returned by your queries, you can use the <code>--serialize</code> flag, which will derive <code>Serialize</code> on your row types.</p>
<h3 id="podman"><a class="header" href="#podman"><code>podman</code></a></h3>
<p>You can use <code>podman</code> as a container manager by passing the <code>-p</code> or <code>--podman</code> flag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api-1"><a class="header" href="#api-1">API</a></h1>
<p>Cornucopia's API offers functionalities similar to the CLI. The main benefit of the API over the CLI is to facilitate programmatic use cases and expose useful abstractions (e.g. an error type).</p>
<p>For more information, you can read the library API <a href="https://docs.rs/crate/cornucopia/latest">docs</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="error-reporting"><a class="header" href="#error-reporting">Error reporting</a></h1>
<p>One of Cornucopia's core goals is to provide best-in-class error reporting. For example, let's say you tried to declare a nullable field, but the query doesn't have a field with this name. You'll receive an error message such as this, <em>before runtime</em>:</p>
<pre><code>× unknown field
   ╭─[queries/test.sql:1:1]
 1 │ --! author: (age?)
   ·              ─┬─
   ·               ╰── no field with this name was found
 2 │ SELECT * FROM author;
   ╰────
  help: use one of those names: id, name
</code></pre>
<p>This helps you catch any malformed query annotation, and will offer helpful hints to get you there. If your development environment supports links, you should be able to click the path (here <code>queries/test.sql:1:1</code>) to bring you directly to the error site in your SQL code.</p>
<p>Cornucopia's error reporting is quite extensive and covers a lot more than the simple case above. You can take a look at our internal <code>integration</code> crate to see our whole error reporting suite.</p>
<h2 id="error-type"><a class="header" href="#error-type">Error type</a></h2>
<p>Cornucopia's library API provides a fully fleshed-out error type that you can use if you need more complex error-handling behavior.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="writing-queries"><a class="header" href="#writing-queries">Writing queries</a></h1>
<p>Your queries consist of PostgreSQL statements using named parameters and decorated by special comment annotations.</p>
<p>Each query file can contain as many queries as you want and will be translated into a submodule inside your generated code file.</p>
<h2 id="named-parameters"><a class="header" href="#named-parameters">Named parameters</a></h2>
<p>To make it easier to write robust queries, Cornucopia uses named bind parameters for queries. Named bind parameters start with a colon and are followed by an identifier like <code>:this</code>. This is only for user convenience though, behind the scenes the query is rewritten using pure PostgreSQL syntax.</p>
<p>It may seem like a gratuitous deviation from PostgreSQL, but the improved expressivity is worth it in our opinion.</p>
<div id="admonition-warning" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="writing_queries/writing_queries.html#admonition-warning"></a></p>
</div>
<div>
<p>Queries <strong>MUST</strong> use named parameters (like <code>:name</code>) instead of indexed ones like <code>$3</code>.</p>
</div>
</div>
<h2 id="rust-keywords"><a class="header" href="#rust-keywords">Rust keywords</a></h2>
<p>When generating your code, Cornucopia will automatically escape identifiers that collide with non-strict Rust keywords. For example, if your SQL query has a column named <code>async</code>, it will be generated as <code>r#async</code>. This can be useful sometimes, but you should avoid such collisions if possible because it makes the generated code more cumbersome.</p>
<p>Strict keywords will result in a code generation error.</p>
<h2 id="annotations"><a class="header" href="#annotations">Annotations</a></h2>
<p>Each SQL query that is to be used with Cornucopia must be annotated using simple SQL comments. These special comments are parsed by Cornucopia and allow you to customize the generated code.</p>
<p>In addition to query annotations, you can also use type annotations to reuse returned columns and parameters between multiple queries.</p>
<p>The next subsections cover query and type annotations in greater detail.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query-annotations"><a class="header" href="#query-annotations">Query annotations</a></h1>
<p>Query annotations decorate a SQL statement and describe the name, parameters and returned row columns of the query.</p>
<p>At their most basic, they look like this</p>
<pre><code class="language-sql">--! authors_from_country
SELECT id, name, age 
FROM Authors 
WHERE Authors.nationality = :country;
</code></pre>
<p>The <code>--!</code> token indicates a Cornucopia query annotation, and <code>authors_from_country</code> is the name of the query.</p>
<p>Cornucopia will actually prepare your queries against your schema, automatically finding the parameters, row columns and their respective types. That is why in most simple queries, you don't have to specify the parameters or row columns: only the query name is required.</p>
<p>That said, you can also go further than this simple syntax in order to customize your queries, as you will learn in the next sections </p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="writing_queries/query_annotations.html#admonition-note"></a></p>
</div>
<div>
<p>Query annotations are declared with this token: <code>--!</code></p>
</div>
</div>
<h2 id="nullity"><a class="header" href="#nullity">Nullity</a></h2>
<p>By default, parameters and returned row columns will all be inferred as non-null. If you want to control their nullity, you can use the question mark (<code>?</code>) syntax:</p>
<pre><code class="language-sql">--! authors_from_country (country?) : (age?)
SELECT id, name, age 
FROM Authors 
WHERE Authors.nationality = :country;
</code></pre>
<p>The <code>(country?)</code> and <code>(age?)</code> annotations mean that the parameter <code>country</code> and returned column <code>age</code> will be inferred as nullable (<code>Option</code> in Rust). </p>
<div id="admonition-note-1" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="writing_queries/query_annotations.html#admonition-note-1"></a></p>
</div>
<div>
<p>Use a colon (<code>:</code>) to separate bind parameters from row columns (both are optional, only the query name is required).</p>
</div>
</div>
<p>You can also granularly modify the nullity of composites and arrays like so:</p>
<pre><code class="language-sql">--! example_query : (compos?.some_field?, arr?[?])
SELECT compos, arr 
FROM example 
</code></pre>
<p>which means that the <code>compos</code> column and its field <code>some_field</code> are both nullable and that the <code>arr</code> column and its elements are also nullable.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="type-annotations"><a class="header" href="#type-annotations">Type annotations</a></h1>
<p>Type annotations allow you to customize the structs that Cornucopia generates for your rows (and parameters, see <a href="writing_queries/type_annotations.html#parameter-structs">the section below</a>). Furthermore, this allows you to share these types between multiple queries.</p>
<p>To create type annotations, declare them using the <code>--:</code> syntax. Type annotations only need to declare the nullable columns. Here's how it looks:</p>
<pre><code class="language-sql">--: Author(age?)

--! authors : Author
SELECT name, age FROM Authors;

--! authors_from_country (country?) : Author
SELECT name, age
FROM Authors
WHERE Authors.nationality = :country;
</code></pre>
<p>This will define a struct named <code>Author</code> containing typed fields for the <code>name</code> and <code>age</code> columns (with <code>age</code> being nullable). The same struct will be used for the <code>authors</code> and <code>authors_from_country</code> queries.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="writing_queries/type_annotations.html#admonition-note"></a></p>
</div>
<div>
<p>Type annotations are declared with this token: <code>--:</code></p>
</div>
</div>
<h2 id="inline-types"><a class="header" href="#inline-types">Inline types</a></h2>
<p>You can also define type inline if you don't plan on reusing them across multiple queries:</p>
<pre><code class="language-sql">--! authors_from_country (country?) : Author()
SELECT id, name, age 
FROM Authors 
WHERE Authors.nationality = :country;
</code></pre>
<p>Notice how inline types <strong>must</strong> have a set of parenthesis describing their nullable columns. This syntax is often more compact for simple cases. It doesn't have any other special meaning otherwise.</p>
<h2 id="parameter-structs"><a class="header" href="#parameter-structs">Parameter structs</a></h2>
<p>Cornucopia will <strong>automatically</strong> generate a parameter struct <strong>if it has more than one column</strong>. The name of the parameter struct is based on the name of the query. You can still manually generate a parameter struct using a type annotation or an inline type.</p>
<p>In any case, note that you don't <em>need</em> a parameter struct, you can always work directly with the query function (see the section <a href="writing_queries/./../using_queries/using_queries.html#building-the-query-object">query usage</a>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-your-generated-queries"><a class="header" href="#using-your-generated-queries">Using your generated queries</a></h1>
<p>Once you have written your queries and generated your Rust code with Cornucopia, it's time to use them. Hurray 🎉!</p>
<p>Let's say you have generated your Rust module into <code>src/cornucopia.rs</code>, then this is as simple as importing the items you need from it, like so:</p>
<pre><code class="language-rust">mod cornucopia;

use cornucopia::authors;</code></pre>
<h1 id="building-the-query-object"><a class="header" href="#building-the-query-object">Building the query object</a></h1>
<p>Building a query object starts with either the query function:</p>
<pre><code class="language-rust">authors().bind(&amp;client, Some(&quot;Greece&quot;));</code></pre>
<p>or the generated parameter struct:</p>
<pre><code class="language-rust">use cornucopia_async::Params;

authors().params(
    &amp;client, 
    AuthorsParams {
        country: Some(&quot;Greece&quot;)
    }
);</code></pre>
<p>The query function is useful when you have a few obvious parameters, while the parameter struct is more explicit.</p>
<p>Note that in order to use the <code>params</code> method, you need to import the <code>Params</code> trait from your (sync or async) cornucopia client.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="using_queries/using_queries.html#admonition-note"></a></p>
</div>
<div>
<p>Queries that don't have a return value (simple insertions, for example) don't generate a query object. Instead, when calling <code>bind</code> or <code>params</code> they execute and return the number of rows affected.</p>
</div>
</div>
<h1 id="row-mapping-optional"><a class="header" href="#row-mapping-optional">Row mapping (optional)</a></h1>
<p>Query objects have a <code>map</code> method that allows them to transform the query's returned rows without requiring intermediate allocation. The following example is pretty contrived but illustrates how you can use this feature.</p>
<pre><code class="language-rust">enum Country {
    Greece,
    TheRest
}

impl&lt;'a&gt; From&lt;&amp;'a str&gt; for Country {
    fn from(s: &amp;'a str) -&gt; Self {
        if s == &quot;Greece&quot; {
            Self::Greece
        } else {
            Self::TheRest
        }
    }
}

struct CustomAuthor {
    full_name: String,
    country: Country,
    age: usize,
}

authors()
    .bind(&amp;client)
    .map(|author| {
        let full_name = format!(
            &quot;{}, {}&quot;,
            author.last_name.to_uppercase(),
            author.first_name
        );
        let country = Country::from(author.country);
        CustomAuthor {
            full_name,
            country,
            age: author.age,
        }
    });</code></pre>
<p>The result of a map is another query object.</p>
<h1 id="getting-rows-out-of-your-queries"><a class="header" href="#getting-rows-out-of-your-queries">Getting rows out of your queries</a></h1>
<p>Once the query object has been built, use one of the following methods to select the expected number of rows:</p>
<ul>
<li><code>opt</code>: one or zero rows (error otherwise).</li>
<li><code>one</code>: exactly one row (error otherwise).</li>
<li><code>iter</code>: iterator of zero or more rows.</li>
<li><code>all</code>: like <code>iter</code>, but collects the rows in a  <code>Vec</code>.</li>
</ul>
<p>Here are some example uses:</p>
<pre><code class="language-rust">author_by_id().bind(&amp;client, &amp;0).opt().await?;
author_by_id().bind(&amp;client, &amp;0).one().await?; // Error if this author id doesn't exist
authors().bind(&amp;client).all().await?;
authors().bind(&amp;client).iter().await?.collect::&lt;Vec&lt;_&gt;&gt;(); // Acts the same as the previous line</code></pre>
<div id="admonition-note-1" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="using_queries/using_queries.html#admonition-note-1"></a></p>
</div>
<div>
<p>If your queries are sync, you don't need to <code>.await</code> them.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="ergonomic-parameters"><a class="header" href="#ergonomic-parameters">Ergonomic parameters</a></h1>
<p>To make working with bind parameters, Cornucopia uses umbrella traits that allow you to pass different concrete types to the same query.</p>
<p>For example:</p>
<pre><code class="language-rust">authors_by_first_name.bind(&amp;client, &amp;&quot;John&quot;).all(); // This works
authors_by_first_name.bind(&amp;client, &amp;String::from(&quot;John&quot;)).all(); // This also works</code></pre>
<p>Here's the list of umbrella traits and the concrete types they abstract over.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="using_queries/ergonomic_parameters.html#admonition-note"></a></p>
</div>
<div>
<p>The pseudo trait bounds given here are very informal, but they should be easy enough to understand.</p>
<p>If you need to see exactly what the trait bounds are, these traits are contained in the <code>cornucopia_client_core</code> crate.</p>
</div>
</div>
<h2 id="stringsql"><a class="header" href="#stringsql"><code>StringSql</code></a></h2>
<ul>
<li><code>String</code></li>
<li><code>&amp;str</code></li>
<li><code>Cow&lt;'_, str&gt;</code></li>
<li><code>Box&lt;str&gt;</code></li>
</ul>
<h2 id="bytessql"><a class="header" href="#bytessql"><code>BytesSql</code></a></h2>
<ul>
<li><code>Vec&lt;u8&gt;</code></li>
<li><code>&amp;[u8]</code></li>
</ul>
<h2 id="jsonsql"><a class="header" href="#jsonsql"><code>JsonSql</code></a></h2>
<p><em>(This trait is only available if the client crate has the <code>with-serde_json-1</code> enabled)</em></p>
<ul>
<li><code>serde_json::Value</code></li>
<li><code>postgres_types::Json</code></li>
</ul>
<h2 id="arraysql"><a class="header" href="#arraysql"><code>ArraySql</code></a></h2>
<ul>
<li><code>Vec&lt;T&gt;</code></li>
<li><code>&amp;[T]</code></li>
<li><code>IterSql</code></li>
</ul>
<h3 id="notes-on-itersql"><a class="header" href="#notes-on-itersql">Notes on <code>IterSql</code></a></h3>
<p>This is a wrapper type available in the client crates. It allows you to treat an iterator as an <code>ArraySql</code> for the purpose of passing parameters.</p>
<div id="admonition-note-1" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="using_queries/ergonomic_parameters.html#admonition-note-1"></a></p>
</div>
<div>
<p>Ergonomic parameters are not supported in composite types yet. This means that composite types fields will only accept concrete types. It should be possible to lift this restriction in the future.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="database-connections"><a class="header" href="#database-connections">Database connections</a></h1>
<p>Depending on your choice of driver (sync or async) and pooling, your generated queries will accept different types of connections.</p>
<p>The following list details supported connections for each configuration.</p>
<h2 id="sync-2"><a class="header" href="#sync-2">Sync</a></h2>
<ul>
<li><code>postgres::Client</code></li>
<li><code>postgres::Transaction</code></li>
</ul>
<h2 id="async-1"><a class="header" href="#async-1">Async</a></h2>
<ul>
<li><code>tokio_postgres::Client</code></li>
<li><code>tokio_postgres::Transaction</code></li>
</ul>
<h2 id="async--deadpool"><a class="header" href="#async--deadpool">Async + Deadpool</a></h2>
<ul>
<li><code>tokio_postgres::Client</code></li>
<li><code>tokio_postgres::Transaction</code></li>
<li><code>deadpool_postgres::Client</code></li>
<li><code>deadpool_postgres::Transaction</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>The repository contains a few examples to get you going.</p>
<ul>
<li>The basic example showcases the basic workflow with simple queries. This example is available in both <a href="https://github.com/cornucopia-rs/cornucopia/tree/main/examples/basic_sync">sync</a> and <a href="https://github.com/cornucopia-rs/cornucopia/tree/main/examples/basic_async">async</a> versions.</li>
<li>The <a href="https://github.com/cornucopia-rs/cornucopia/tree/main/examples/auto_build">automatic query build</a> example showcases how to integrate Cornucopia's API inside a build script to automatically rebuild your Rust queries when your PostgreSQL queries change.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-contribute"><a class="header" href="#how-to-contribute">How to contribute</a></h1>
<p>If you have a feature request, head over to our <a href="https://github.com/cornucopia-rs/cornucopia">Github repository</a> and open an issue or a pull request.</p>
<p>You want to become a member of the project? Thank you! You can join our discord server to get in touch with our contributors.</p>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->


                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">

        </nav>

    </div>




    <script type="text/javascript">
        window.playground_copyable = true;
    </script>


    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

    <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->

    <script type="text/javascript">
        window.addEventListener('load', function () {
            window.setTimeout(window.print, 100);
        });
    </script>

</body>

</html>